<!DOCTYPE  html>
<html>
<head>
<title>ValCarto Beta</title>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<style type="text/css">
html {
height: 100%;
}

body {
height: 100%;
margin: 0px;
padding: 0px;
}

#map_canvas {
position: absolute;
top: 45px;
bottom: 0px;
width: 100%;
}

#header {
height: 45px;
text-align: center;
background-color: black;
}

.boutonsCouches{
height: 30px;
width: 200px;
padding-left: 15px;
padding-right: 15px;
margin-left: 15px;
margin-right: 15px;
text-align: center;
font-family: "Open Sans",Verdana,sans-serif;
font-size: 12px;
color: white;
outline: 0;
border: 0;
margin-top: 7.5px;
}

#education{
background-color: rgba(0,157,224,1);
}

#sport{
background-color: rgba(194,0,18,1);
}

#art{
background-color: rgba(161,192,53,1);
}

#servicesPublics{
background-color: rgba(242,203,0,1);
}

.infoWindow * {
padding: 0;
margin: 2px;
width: 400px;
}

.type {
font-size: 10px;
margin-bottom: 3px;
font-style: italic;
}

.nomProperty {
text-align: center;
width: 100px;
font-weight: bold;
}

.siteweb {
text-align: center
}
</style>
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false" ></script>
<script type="text/javascript">

function initialize() {

	// import de la carte MapQuest
	
	mapQuestType = new google.maps.ImageMapType({
		getTileUrl: function(coord, zoom) {
			return "http://otile1.mqcdn.com/tiles/1.0.0/map/" +
			zoom + "/" + coord.x + "/" + coord.y + ".png";
		},
		tileSize: new google.maps.Size(256, 256),
		isPng: true,
		alt: "MapQuest layer (données OSM)",
		name: "MapQuest",
		maxZoom: 20
	});
	
	
	// options et affichage de la carte
	
	var latlng= new google.maps.LatLng(50.361, 3.52);
	var myOptions = {
		zoom: 14,
		center: latlng,
		mapTypeControlOptions: {mapTypeIds: [google.maps.MapTypeId.ROADMAP,google.maps.MapTypeId.SATELLITE,'MapQuest'],style: google.maps.MapTypeControlStyle.DROPDOWN_MENU},
		mapTypeId: 'MapQuest'
	};
	map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
	map.mapTypes.set('MapQuest',mapQuestType);
	
	// import du masque des communes voisines
	
	dataCom = new google.maps.Data();
	dataCom.loadGeoJson('com.geojson');
	dataCom.setStyle({fillOpacity:0.6,strokeWeight:0,clickable:false});
	dataCom.setMap(map);
	
	// import des données GeoJson
	
	dataCompl = new google.maps.Data();
	dataCompl.addListener('addfeature',splitData);
	dataCompl.loadGeoJson('statues.geojson');
	dataCompl.loadGeoJson('artbati.geojson');
	
	// fonction splitData à l'import des données pour répartir selon leurs types, icones, etc...
	
	function splitData(AddFeatureEvent){
		var feature = AddFeatureEvent.feature;
		var type = feature.getProperty("type");
		var layer_index = (!layers[type] || layers[type]===undefined) ? "problems" : type;
		layers[layer_index][0].add(feature);
	};
	
	// Création des couches thématiques dans un objet contenant plusieurs array : [0] = création de l'objet Data ; [1] = lien logo ; [2] = Nom à afficher dans la légende ; [3] = sizeIcon ; [4] = zindex ; [5] = anchor
	
	layers = {
		statues: [ new google.maps.Data(), "pictos/statues.png" , "Statue" , new google.maps.Size(20,25) , 1 , new google.maps.Point(7,23)],
		bibliotheque: [ new google.maps.Data(), "pictos/bibliotheque.png" , "Bibliothèque" , new google.maps.Size(40,38) , 3 , new google.maps.Point(15,37)],
		conservatoire : [ new google.maps.Data(), "pictos/conservatoire.png" , "Conservatoire" , new google.maps.Size(40,38) , 2 , new google.maps.Point(15,37)],
		officeTourisme : [ new google.maps.Data(), "pictos/officeTourisme.png" , "Office de tourisme" , new google.maps.Size(40,38) , 2 , new google.maps.Point(15,37)],
		auditorium : [ new google.maps.Data(), "pictos/auditorium.png" , "Auditorium" , new google.maps.Size(40,38) , 2 , new google.maps.Point(15,37)],
		theatre : [ new google.maps.Data(), "pictos/theatre.png" , "Théâtre" , new google.maps.Size(40,38) , 2 , new google.maps.Point(15,37)],
		musee : [ new google.maps.Data(), "pictos/musee.png" , "Musée" , new google.maps.Size(40,38) , 2 , new google.maps.Point(15,37)],
		problems : [ new google.maps.Data(), "" , "" , new google.maps.Size(40,38) , 2 , new google.maps.Point(15,37)]
	};
	
	// Ajout des couches et paramètrage de leur style
	
	for (index in layers){
		layers[index][0].setMap(map); // affichage des couches sur la carte
		layers[index][0].setStyle(function(feature){ // fonction pour retourner en titre le Libellé du feature voir ce sujet : http://stackoverflow.com/questions/25787502/add-tooltip-on-a-data-feature-object-like-we-can-do-for-the-marker/25792796#25792796
			return {
				title: feature.getProperty('nom')||null, // défini le titre en fonction de son Libellé
				icon: {url: layers[feature.getProperty('type')][1], scaledSize: layers[feature.getProperty('type')][3], anchor: layers[feature.getProperty('type')][5]}, // défini l'icone de chaque couche en fonction de son genre
				zIndex: layers[feature.getProperty('type')][4]
			};
		});
		layers[index][0].addListener('click',clic); // ajout d'un événement clic sur les entités
	};
	
	// fonction quand on clique sur une entité
	
	function clic(event){
	
		// si une fenêtre d'information est déjà ouverte ou un marqueur animé on les ferme
		
		resetInfAni();
	
		// construction du code HTML à insérer dans la fenêtre d'information
		
		htmlInfo = '<div class="infoWindow">'
		feature = event.feature;
		htmlInfo = htmlInfo + '<h3 class="nomInfobulle">' + feature.getProperty('nom') + '</h3>';
		htmlInfo = htmlInfo + '<p class="type">' + layers[event.feature.getProperty('type')][2] + '</p><hr><table class="tableInfos>"'
		feature.forEachProperty(function(value,property) {
			if (property != 'id' && property != 'nom' && property != 'type' && property != 'siteweb' && value != null){
				if (dicoProperty[property]){
					htmlInfo = htmlInfo + '<tr><td class="nomProperty">' + dicoProperty[property][0] + '</td><td>' + value + '</td>';
				} else {
					htmlInfo = htmlInfo + '<tr><td class="nomProperty">' + property + '</td><td>' + value + '</td>';
				};
			};
		});
		htmlInfo = htmlInfo + '</table>';
		if (feature.getProperty('siteweb')){
			htmlInfo = htmlInfo + '<p class="siteweb"><a href="' + feature.getProperty('siteweb') + '" target="_blank">Accéder au site internet</a>';
		};
		htmlInfo = htmlInfo + '</div>';
		
		// création et ouverture de la fenêtre d'information

		infoWindow = new google.maps.InfoWindow({ content: htmlInfo, position: event.latLng, pixelOffset: {width:0, height:-40}});
		infoWindow.open(map);
		infoWindow.addListener("closeclick",resetInfAni);
		
		// animation de l'icone
		
		latFeat = event.latLng.lat();
		lngFeat = event.latLng.lng();
		featureAnim = event.feature;
		featureAnim.setGeometry(0,0); // je déplace le feature pour qu'il ne soit plus visible sur la carte
		marker = new google.maps.Marker({position:{lat:latFeat,lng:lngFeat},map:map,icon:{url: layers[featureAnim.getProperty("type")][1], scaledSize: layers[feature.getProperty('type')][3], anchor: layers[feature.getProperty('type')][5]},animation: google.maps.Animation.BOUNCE}); // je créé un marker animé qui le remplace
	};
	
	function resetInfAni(){
	
		// si une fenêtre d'information est déjà ouverte, on la ferme
		
		if (typeof infoWindow != 'undefined') {
			infoWindow.close();
		};
		
		// s'il y a encore un marker animé, le supprimer et remettre le feature d'origine
		
		if (typeof marker != 'undefined' && marker.getMap() != 'null') {
			featureAnim.setGeometry({lat:latFeat,lng:lngFeat});
			marker.setMap(null);
		};
	};
	
	dicoProperty = {
		tel : ["Téléphone"],
		auteursDat : ["Dates de l'auteur"],
		annee : ["Année"],
		comment : ["Remarque"]
	};
};
</script>
</head>
<body onload="initialize()">
<div id="header">
	<button class="boutonsCouches" id="education">ECOLES ET CRECHES</button>
	<button class="boutonsCouches" id="sport">EQUIPEMENTS SPORTIFS</button>
	<button class="boutonsCouches" id="art">ART</button>
	<button class="boutonsCouches" id="servicesPublics">SERVICES PUBLICS</button>
</div>	
<div id="map_canvas"></div>
</body>
</html>
